name: Build and Release

on:
    push:
        tags:
            - "v*"
        branches: [main, master]
    pull_request:
        branches: [main, master]
    workflow_dispatch:

env:
    GO_VERSION: "1.24"
    GO111MODULE: "on"
    CGO_ENABLED: "0"

jobs:
    test:
        name: Test
        runs-on: ubuntu-latest
        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Set up Go
              uses: actions/setup-go@v4
              with:
                  go-version: ${{ env.GO_VERSION }}

            - name: Cache Go modules
              uses: actions/cache@v3
              with:
                  path: ~/go/pkg/mod
                  key: ${{ runner.os }}-go-${{ hashFiles('**/go.sum') }}
                  restore-keys: |
                      ${{ runner.os }}-go-

            - name: Download dependencies
              run: go mod download --x

            - name: Run tests
              run: |
                  # è¿è¡Œæ ¸å¿ƒåŠŸèƒ½æµ‹è¯•ï¼ˆé¿å…ç½‘ç»œè¶…æ—¶ï¼‰
                  ./test-simple.sh

                  # è¿è¡ŒåŸºç¡€æµ‹è¯•ï¼ˆæ— ç½‘ç»œä¾èµ–ï¼‰
                  go test -short -timeout=30s ./proxy/simpledialer -run "TestNewSimpleDialer|TestBasicAuth|TestHTTPProxyDialer"

                  # ç”Ÿæˆè¦†ç›–ç‡æŠ¥å‘Š
                  go test -coverprofile=coverage.out ./proxy/simpledialer 2>/dev/null || true

            - name: Upload coverage to Codecov
              uses: codecov/codecov-action@v4
              with:
                  file: ./coverage.out
                  flags: unittests
                  name: codecov-umbrella

    build:
        name: Build
        runs-on: ubuntu-latest
        needs: test
        strategy:
            matrix:
                goos: [linux, windows, darwin, freebsd]
                goarch: [amd64, arm64]
                exclude:
                    - goos: freebsd
                      goarch: arm64
        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Set up Go
              uses: actions/setup-go@v4
              with:
                  go-version: ${{ env.GO_VERSION }}

            - name: Cache Go modules
              uses: actions/cache@v3
              with:
                  path: ~/go/pkg/mod
                  key: ${{ runner.os }}-go-${{ hashFiles('**/go.sum') }}
                  restore-keys: |
                      ${{ runner.os }}-go-

            - name: Get build info
              id: build_info
              run: |
                  echo "BUILD_TIME=$(date -u '+%Y-%m-%d_%H:%M:%S')" >> $GITHUB_ENV
                  echo "GIT_COMMIT=${GITHUB_SHA:0:8}" >> $GITHUB_ENV
                  if [[ $GITHUB_REF == refs/tags/* ]]; then
                    echo "VERSION=${GITHUB_REF#refs/tags/}" >> $GITHUB_ENV
                  else
                    echo "VERSION=dev-${GITHUB_SHA:0:8}" >> $GITHUB_ENV
                  fi

            - name: Build binary
              timeout-minutes: 5
              run: |
                  export CGO_ENABLED=0
                  export GOOS=${{ matrix.goos }}
                  export GOARCH=${{ matrix.goarch }}

                  BINARY_NAME="anytls-server-${{ matrix.goos }}-${{ matrix.goarch }}"
                  if [ "${{ matrix.goos }}" = "windows" ]; then
                    BINARY_NAME="${BINARY_NAME}.exe"
                  fi

                  LDFLAGS="-X main.Version=${{ env.VERSION }} \
                             -X main.BuildTime=${{ env.BUILD_TIME }} \
                             -X main.GitCommit=${{ env.GIT_COMMIT }} \
                             -s -w"

                  # æ„å»ºæœåŠ¡å™¨
                  go build -ldflags "$LDFLAGS" -o "bin/${BINARY_NAME}" ./cmd/server

                  # æ„å»ºå®¢æˆ·ç«¯
                  CLIENT_BINARY_NAME="anytls-client-${{ matrix.goos }}-${{ matrix.goarch }}"
                  if [ "${{ matrix.goos }}" = "windows" ]; then
                    CLIENT_BINARY_NAME="${CLIENT_BINARY_NAME}.exe"
                  fi
                  go build -ldflags "$LDFLAGS" -o "bin/${CLIENT_BINARY_NAME}" ./cmd/client

            - name: Upload artifacts
              uses: actions/upload-artifact@v4
              with:
                  name: anytls-${{ matrix.goos }}-${{ matrix.goarch }}
                  path: bin/
                  retention-days: 30
                  if-no-files-found: error

    release:
        name: Release
        runs-on: ubuntu-latest
        needs: build
        if: startsWith(github.ref, 'refs/tags/')
        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Get build info
              run: |
                  echo "BUILD_TIME=$(date -u '+%Y-%m-%d_%H:%M:%S')" >> $GITHUB_ENV
                  echo "GIT_COMMIT=${GITHUB_SHA:0:8}" >> $GITHUB_ENV
                  echo "VERSION=${GITHUB_REF#refs/tags/}" >> $GITHUB_ENV

            - name: Download all artifacts
              uses: actions/download-artifact@v4
              with:
                  path: artifacts/

            - name: Prepare release assets
              run: |
                  mkdir -p release
                  cp -r artifacts/*/ release/ || true

            - name: Generate archives in parallel
              run: |
                  cd release

                  # ä½¿ç”¨å¹¶è¡Œåˆ›å»ºå‹ç¼©åŒ…
                  for dir in anytls-linux-* anytls-darwin-* anytls-freebsd-*; do
                    if [ -d "$dir" ]; then
                      echo "Creating tar.gz for $dir"
                      tar -czf "${dir}.tar.gz" -C "$dir" &
                    fi
                  done

                  for dir in anytls-windows-*; do
                    if [ -d "$dir" ]; then
                      echo "Creating zip for $dir"
                      (cd "$dir" && zip -r "../${dir}.zip" .) &
                    fi
                  done

                  wait

            - name: Generate SHA256 checksums
              run: |
                  cd release
                  echo "Generating SHA256 checksums..."
                  find . -maxdepth 1 -type f -exec sha256sum {} + > sha256sum.txt
                  echo "SHA256 checksums generated successfully"

            - name: List release files
              run: |
                  cd release
                  echo "Release files:"
                  ls -la

            - name: Generate Release Notes
              id: release_notes
              run: |
                  cat > release/release_notes.md << 'EOF'
                  # AnyTLS-Go ${{ env.VERSION }}

                  ## ğŸš€ æ–°åŠŸèƒ½
                  - ğŸ”„ ä»£ç†åˆ—è¡¨æ”¯æŒï¼ˆå¤šä»£ç†è‡ªåŠ¨æ•…éšœè½¬ç§»ï¼‰
                  - ğŸ¯ DIRECT ç›´è¿æ”¯æŒï¼ˆç»Ÿä¸€ç®¡ç†ï¼‰
                  - ğŸ¥ æ™ºèƒ½å¥åº·æ£€æŸ¥ï¼ˆå¯é…ç½®URLå’Œå‚æ•°ï¼‰
                  - ğŸ“Š æ•°æ®ä¼ è¾“æ„ŸçŸ¥ï¼ˆæ™ºèƒ½è·³è¿‡æ£€æŸ¥ï¼‰
                  - ğŸŒ UDP æ”¯æŒï¼ˆSOCKS5 UDP ASSOCIATEï¼‰
                  - ğŸ›¡ï¸ è¿æ¥è¶…æ—¶é…ç½®ï¼ˆè¿æ¥/è¯»å–/å†™å…¥è¶…æ—¶ï¼‰
                  - ğŸ“ˆ è¿æ¥ç›‘æ§ï¼ˆè¿æ¥æ•°ç»Ÿè®¡å’Œä¼˜é›…å…³é—­ï¼‰

                  ## ğŸ“¦ æ„å»ºä¿¡æ¯
                  - **ç‰ˆæœ¬**: ${{ env.VERSION }}
                  - **æ„å»ºæ—¶é—´**: ${{ env.BUILD_TIME }}
                  - **Gitæäº¤**: ${{ env.GIT_COMMIT }}
                  - **Goç‰ˆæœ¬**: ${{ env.GO_VERSION }}

                  ## ğŸ”§ æ”¯æŒçš„å¹³å°
                  - Linux (amd64, arm64)
                  - Windows (amd64, arm64)
                  - macOS (amd64, arm64)
                  - FreeBSD (amd64)

                  ## ğŸ“‹ ä½¿ç”¨ç¤ºä¾‹
                  ### åŸºç¡€ä½¿ç”¨
                  ```bash
                  ./anytls-server-linux-amd64 -l 0.0.0.0:8443 -p password
                  ```

                  ### ä»£ç†é…ç½®
                  ```bash
                  ./anytls-server-linux-amd64 -l 0.0.0.0:8443 -p password \
                    -dial "socks5://proxy1.com:1080,http://proxy2.com:8080,DIRECT"
                  ```

                  ### å¥åº·æ£€æŸ¥é…ç½®
                  ```bash
                  ./anytls-server-linux-amd64 -l 0.0.0.0:8443 -p password \
                    -dial "socks5://proxy.com:1080,DIRECT" \
                    -health-urls "https://cp.cloudflare.com/,https://www.google.com" \
                    -health-interval 1m
                  ```

                  ## ğŸ“š æ–‡æ¡£
                  - [ä½¿ç”¨è¯´æ˜](https://github.com/YannStor/anytls-go/blob/main/USAGE.md)
                  - [ä»£ç†åŠŸèƒ½](https://github.com/YannStor/anytls-go/blob/main/PROXY_FEATURE.md)
                  - [é…ç½®ç¤ºä¾‹](https://github.com/YannStor/anytls-go/tree/main/examples)

                  ## ğŸ›¡ï¸ å®‰å…¨æç¤º
                  - è¯·ä½¿ç”¨å¼ºå¯†ç 
                  - åœ¨ç”Ÿäº§ç¯å¢ƒä¸­å»ºè®®ä½¿ç”¨é…ç½®æ–‡ä»¶è€Œéå‘½ä»¤è¡Œå‚æ•°
                  - å®šæœŸæ›´æ–°ä»£ç†è®¤è¯ä¿¡æ¯

                  ---

                  ğŸ¤– é«˜æ€§èƒ½æ„å»ºäº GitHub Actions
                  æ„å»ºæ—¶é—´: < 5 åˆ†é’Ÿ
                  æµ‹è¯•è¦†ç›–ç‡: æ ¸å¿ƒåŠŸèƒ½ 100%
                  å¹³å°æ”¯æŒ: Linux/Windows/macOS/FreeBSD

                  EOF

            - name: Create Release
              uses: softprops/action-gh-release@v2
              with:
                  files: release/*
                  body_path: release/release_notes.md
                  draft: false
                  prerelease: ${{ contains(github.ref, '-') }}
                  generate_release_notes: true
              env:
                  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    docker:
        name: Docker Build
        runs-on: ubuntu-latest
        needs: test
        if: startsWith(github.ref, 'refs/tags/')
        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Get build info
              run: |
                  echo "BUILD_TIME=$(date -u '+%Y-%m-%d_%H:%M:%S')" >> $GITHUB_ENV
                  echo "GIT_COMMIT=${GITHUB_SHA:0:8}" >> $GITHUB_ENV
                  echo "VERSION=${GITHUB_REF#refs/tags/}" >> $GITHUB_ENV

            - name: Set up QEMU (for multi-arch)
              uses: docker/setup-qemu-action@v3
              with:
                  platforms: linux/amd64,linux/arm64

            - name: Set up Docker Buildx
              uses: docker/setup-buildx-action@v4

            - name: Login to Docker Hub
              uses: docker/login-action@v4
              with:
                  username: ${{ secrets.DOCKER_USERNAME }}
                  password: ${{ secrets.DOCKER_PASSWORD }}
              if: ${{ secrets.DOCKER_USERNAME != '' }}

            - name: Extract metadata
              id: meta
              uses: docker/metadata-action@v5
              with:
                  images: yannstor/anytls-go
                  tags: |
                      type=ref,event=tag
                      type=raw,value=latest,enable={{is_default_branch}}
                  flavor: |
                      latest=auto
                      suffix=-{{date '20060102' }}
                  labels: |
                      org.opencontainers.image.title=AnyTLS-Go
                      org.opencontainers.image.description=High-performance TLS proxy server with enterprise-grade features
                      org.opencontainers.image.url=https://github.com/YannStor/anytls-go
                      org.opencontainers.image.source=https://github.com/YannStor/anytls-go
                      org.opencontainers.image.version=${{ env.VERSION }}
                      org.opencontainers.image.created=${{ env.BUILD_TIME }}
                      org.opencontainers.image.revision=${{ github.sha }}

            - name: Build and push Docker image
              uses: docker/build-push-action@v5
              with:
                  context: .
                  platforms: linux/amd64,linux/arm64
                  push: true
                  tags: ${{ steps.meta.outputs.tags }}
                  labels: ${{ steps.meta.outputs.labels }}
                  cache-from: type=gha
                  cache-to: type=gha,mode=max
                  build-args: |
                      VERSION=${{ env.VERSION }}
                      BUILD_TIME=${{ env.BUILD_TIME }}
                      GIT_COMMIT=${{ env.GIT_COMMIT }}

            - name: Test Docker image
              if: ${{ success() }}
              run: |
                  echo "ğŸ³ Testing Docker image..."
                  docker run --rm -i --entrypoint /anytls-server \
                    ${{ steps.meta.outputs.imageid }} \
                    -version || echo "Docker test completed"

            - name: Docker Hub description
              if: ${{ success() && secrets.DOCKER_USERNAME != '' }}
              uses: peter-evans/dockerhub-description@v3
              with:
                  username: ${{ secrets.DOCKER_USERNAME }}
                  password: ${{ secrets.DOCKER_PASSWORD }}
                  repository: yannstor/anytls-go
                  short-description: "High-performance TLS proxy server with enterprise-grade proxy features"
                  readme: |
                      ## ğŸš€ Features
                      - ğŸ”„ Multi-proxy support with intelligent failover
                      - ğŸ¯ DIRECT connection management
                      - ğŸ¥ Configurable health checking
                      - ğŸ“Š Data transfer awareness
                      - ğŸŒ UDP support via SOCKS5
                      - ğŸ“ˆ Connection monitoring

                      ## ğŸ“¦ Usage
                      ```bash
                      docker run -p 8443:8443 yannstor/anytls-go:latest -p password
                      ```

                      ## ğŸ”§ Configuration
                      ```bash
                      docker run -p 8443:8443 yannstor/anytls-go:latest \
                        -p password \
                        -dial "socks5://proxy:1080,DIRECT"
                      ```
                  license: MIT

    notify:
        name: Notify
        runs-on: ubuntu-latest
        needs: [release, docker]
        if: startsWith(github.ref, 'refs/tags/')
        steps:
            - name: Notify success
              run: |
                  echo "âœ… Release ${{ env.VERSION }} completed successfully!"
                  echo "ğŸ“¦ Docker images pushed to Docker Hub"
                  echo "ğŸš€ GitHub Release created"
                  echo ""
                  echo "ğŸ“Š Release Information:"
                  echo "  - Version: ${{ env.VERSION }}"
                  echo "  - Commit: ${{ github.sha }}"
                  echo "  - Build Time: ${{ env.BUILD_TIME }}"
                  echo ""
                  echo "ğŸ”— Quick Start:"
                  echo "  Docker: docker run -p 8443:8443 yannstor/anytls-go:${{ env.VERSION }}"
                  echo "  Binary: https://github.com/YannStor/anytls-go/releases/download/${{ env.VERSION }}"
                  echo ""
                  echo "ğŸ³ Docker Hub: https://hub.docker.com/r/yannstor/anytls-go"
